Task1：completed
# after click "start writing" button in home page, it goes to writing page. add a history review button as reading coache beside "start writing"
# Writing page, the user can write a piece of essay or upload a file or image
# user can select each funtion button to StyleAnalyzer,evaluate,Improvement,Refiner,followup. leave the button function call as placeholder, I will give code for each function.
# it can save above essay, AI outputs into supabase database with user id and date time for review by click "history review" button.

Task2：ready to run
# keep our current orchestration, refer to prompts in wirting_coach.py to create each funtion.
# we still use deepseek for  StyleAnalyzer,evaluate,Improvement,Refiner,followup
# refer to writing_coach class for StyleAnalyzer,evaluate,Improvement,Refiner

task3:next step to run
# for followup prompts, refer to followup.md









class WritingCoachSystem:
    """
    Simplified writing evaluation system using multiple LLM providers.
    Compatible with OpenAI, Gemini, Anthropic, Azure, Ollama, and other providers.
    Includes OCR functionality for image-to-text conversion.
    """

     
    def evaluate_writing(self, writing_sample: str) -> EvaluationResult:
        """
        Complete writing evaluation workflow.
        """

        
        # --- PHASE 1: STYLE & TOPIC ANALYSIS ---
        logger.info("\n[PHASE 1] Analyzing style and topic...")
        style_prompt = f"""Analyze this writing sample for style, topic, tone, and genre:

WRITING SAMPLE:
---
{writing_sample}
---

Provide response in TWO PARTS:

PART 1 - SUMMARY (2-3 sentences): Briefly describe the overall writing style, main topic, tone, and intended audience.

PART 2 - DETAILED ANALYSIS: Provide detailed analysis covering:
1. Writing style (formal, informal, academic, etc.)
2. Topic and subject matter
3. Overall tone
4. Genre and format
5. Target audience

CRITICAL: Be specific and provide clear examples from the text, using exact quotes where possible."""

        style_system = "You are an expert writing style analyst. Provide clear, structured analysis."
        style_response = self._call_llm(style_system, style_prompt)
        style_and_topic = style_response.strip() if style_response else "Unable to analyze style"
        logger.info("✓ Style analysis complete")
        
        # --- PHASE 2: EVALUATE STRENGTHS & WEAKNESSES ---
        logger.info("\n[PHASE 2] Evaluating strengths and weaknesses...")
        eval_prompt = f"""Analyze this writing for strengths and weaknesses:

Analyze this writing for strengths and weaknesses.

CRITICAL DEFINITIONS:
- STRENGTH: Something done WELL that demonstrates writing skill. Must show quality, not just presence. For example:
    * "Uses vivid descriptive language: 'golden sunset'" is a strength
    * "Mentions the Arctic fox" is NOT a strength (just a topic choice)
    * "Uses quotation marks" is NOT a strength (using formatting is basic, not skilled use)
    * "Properly cites sources with author and date" is a strength
    * "Has quotation marks around a fact but no proper citation" is a WEAKNESS (attempted but failed)

- WEAKNESS: Something that hurts writing quality or is done incorrectly. Examples:
    * Grammatical errors: "he don't"
    * Missing citations or improper citations (quotes without source attribution)
    * Run-on sentences or fragments
    * Vague language or unsupported claims
    * Repetitive phrasing

- NOT STRENGTHS: Don't list neutral observations as strengths
    * Simply "uses facts" = neutral, not a strength
    * "mentions multiple sources" = neutral without assessing quality
    * "has an introduction" = expected, not a strength

WRITING:
---
{writing_sample}
---

Provide response in TWO PARTS:

PART 1 - SUMMARY (2-3 sentences): Give an overall assessment focusing on what's done well vs. what needs fixing.

PART 2 - DETAILED FEEDBACK:

STRENGTHS (2-4 items maximum, only genuine quality):
For each strength:
- State the strength clearly
- Quote the specific text showing it (use exact quotes)
- Explain why this demonstrates writing skill

WEAKNESSES (2-5 items, be honest about problems):
For each weakness:
- State the weakness clearly
- Quote the specific problematic text
- Explain the impact on reader understanding

CONSTRAINT: Do NOT list neutral observations or attempts as strengths. If something is attempted but done incorrectly (like citations), mark it as a weakness."""

        eval_system = "You are a professional writing evaluator. Be specific with examples."
        eval_response = self._call_llm(eval_system, eval_prompt)
        
        # Parse strengths and weaknesses
        strengths, weaknesses = self._parse_strengths_weaknesses(eval_response)
        logger.info(f"✓ Found {len(strengths)} strengths, {len(weaknesses)} weaknesses")
        
        # --- PHASE 3: GENERATE IMPROVEMENT SUGGESTIONS ---
        logger.info("\n[PHASE 3] Generating improvement suggestions...")
        coach_prompt = f"""Based on this writing:

Based on this writing, provide specific improvement suggestions:

WRITING:
---
{writing_sample}
---

CRITICAL REQUIREMENTS:
- Every suggestion MUST reference something specific from the actual text
- Do NOT give generic writing advice like "improve grammar" without specifying what
- Each suggestion must show: LOCATION (quote or sentence number), PROBLEM (what's wrong), SOLUTION (how to fix it)
- Suggestions should be prioritized by impact

Provide response in TWO PARTS:

PART 1 - SUMMARY (2-3 sentences): Identify the top 2-3 improvements that would have the biggest impact.

PART 2 - DETAILED IMPROVEMENT SUGGESTIONS (4-6 items only - prioritized):

For each suggestion, provide in this order:
1. LOCATION: Quote the specific problematic text or describe which sentence/paragraph
2. THE ISSUE: What's the problem with this exact text
3. IMPACT: Why this matters for reader understanding
4. SPECIFIC FIX: Rewrite or revise this exact part (show before → after)
5. WHY THIS WORKS: Explain the improvement

Example of GOOD suggestion:
    LOCATION: "he don't know"
    THE ISSUE: Subject-verb disagreement (plural subject requires "do" not "don't")
    IMPACT: Errors reduce reader confidence in the writer's authority
    SPECIFIC FIX: Change "don't" to "doesn't"
    WHY THIS WORKS: Correct grammar makes the sentence clear and professional

Example of BAD suggestion:
    "Improve grammar" - Too vague, doesn't reference actual text

CONSTRAINT: EVERY suggestion must point to specific words/phrases in the writing."""

        coach_system = "You are an encouraging writing coach. Provide specific, actionable suggestions."
        coach_response = self._call_llm(coach_system, coach_prompt)
        suggestions = self._parse_suggestions(coach_response)
        logger.info(f"✓ Generated {len(suggestions)} suggestions")
        
        # --- PHASE 4: CREATE REFINED VERSION ---
        logger.info("\n[PHASE 4] Creating refined version...")
        refine_prompt = f"""Rewrite this writing, improving it while maintaining the original voice:

Rewrite this writing, improving it while maintaining the original voice and meaning:

ORIGINAL:
---
{writing_sample}
---

REVISION PRIORITIES (in order):
1. Fix critical errors (grammar, subject-verb, spelling, missing citations)
2. Improve clarity (replace vague phrases with specific ones)
3. Enhance flow (improve sentence variety and connections)
4. Strengthen evidence (add or improve citations/examples)
5. Maintain student's original voice and intended message

Provide response in TWO PARTS:

PART 1 - SUMMARY OF CHANGES (3-4 sentences): List the specific improvements made and their impact on quality.

PART 2 - REFINED VERSION:
Create an improved version that:
- Fixes all grammar/spelling/citation errors
- Replaces vague language with specific examples
- Improves sentence variety and flow
- Keeps the student's original voice and message intact
- Remains authentic to their thinking (don't rewrite their ideas)

CONSTRAINT: Do NOT change the core message or add new ideas. Improve only the expression and correctness.

After the refined version, add a brief note (2-3 sentences) explaining the specific improvements made."""

        refine_system = "You are an expert editor. Maintain original voice while improving clarity, grammar, and flow."
        refined_response = self._call_llm(refine_system, refine_prompt)
        refined_sample = refined_response.strip() if refined_response else writing_sample
        logger.info("✓ Refined version created")
        
        # Compile results
        result = EvaluationResult(
            style_and_topic=style_and_topic,
            strengths=strengths,
            weaknesses=weaknesses,
            improvement_suggestions=suggestions,
            refined_sample=refined_sample,
            timestamp=datetime.now().isoformat()
        )

        return result

    def _parse_strengths_weaknesses(self, response: str) -> tuple:
        """Extract strengths and weaknesses from response"""
        strengths = []
        weaknesses = []
        
        try:
            lines = response.split('\n')
            current_section = None
            
            for line in lines:
                line = line.strip()
                if 'strength' in line.lower():
                    current_section = 'strengths'
                elif 'weakness' in line.lower():
                    current_section = 'weaknesses'
                elif line and current_section:
                    if line[0].isdigit() or line.startswith('-'):
                        # Remove bullet points and numbering
                        item = line.lstrip('0123456789.-) ').strip()
                        if item:
                            if current_section == 'strengths':
                                strengths.append(item)
                            else:
                                weaknesses.append(item)
        except:
            pass
        
        # Fallback defaults
        if not strengths:
            strengths = ["Clear writing", "Good topic selection"]
        if not weaknesses:
            weaknesses = ["Room for improvement"]
            
        return strengths[:5], weaknesses[:5]

    def _parse_suggestions(self, response: str) -> list:
        """Extract suggestions from response"""
        suggestions = []
        
        try:
            lines = response.split('\n')
            for line in lines:
                line = line.strip()
                if line and (line[0].isdigit() or line.startswith('-')):
                    # Remove numbering and bullets
                    suggestion = line.lstrip('0123456789.-) ').strip()
                    if suggestion:
                        suggestions.append(suggestion)
        except:
            pass
        
        # Fallback
        if not suggestions:
            suggestions = ["Review grammar and punctuation", "Improve sentence variety"]
            
        return suggestions[:7]





